<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Sapitosday 🎸</title>
</head>
<body>
    <div class="container">
        <h1>Sapitosday 🎸</h1>
        <p>¡El juego que se juega con el movimiento de tu dispositivo!</p>
        <p>Apunta el dispositivo hacia la pantalla, ¡y cuando la guitarra esté a punto de caer, muévelo como si le estuvieras dando un sape! Si lo haces a tiempo, aparecerá la nota musical para que completes la melodía.</p>
        <p>Intenta llegar a la nota 50 para un final épico</p>
        <div class="game-container">
            <div id="guitar" class="guitar"></div>
            <div id="target" class="target"></div>
        </div>
        <div class="score-container">
            <div class="notes-container">
                <span id="notes"></span>
            </div>
            <div class="score-text">
                <p>Tu nota es:</p>
                <p id="score">0</p>
            </div>
        </div>
        <button id="start-button">A rockear 🎸</button>
        <div id="end-message" style="display: none;">
            <p id="final-score"></p>
            <button id="restart-button">Jugar de nuevo</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startButton = document.getElementById('start-button');
            const guitar = document.getElementById('guitar');
            const target = document.getElementById('target');
            const scoreDisplay = document.getElementById('score');
            const notesDisplay = document.getElementById('notes');
            const endMessage = document.getElementById('end-message');
            const finalScore = document.getElementById('final-score');
            const restartButton = document.getElementById('restart-button');

            let score = 0;
            let guitarFallTimeout;
            let guitarPosition = 'left';
            let isGameActive = false;

            const audioNotes = {
                're': new Audio('audios/re.mp3'),
                'mi': new Audio('audios/mi.mp3'),
                'fa': new Audio('audios/fa.mp3'),
                'sol': new Audio('audios/sol.mp3'),
                'la': new Audio('audios/la.mp3'),
            };

            const notesOrder = ['re', 'mi', 'fa', 'sol', 'la'];
            let currentNoteIndex = 0;

            function playNote(note) {
                const noteAudio = audioNotes[note];
                if (noteAudio) {
                    noteAudio.currentTime = 0;
                    noteAudio.play();
                }
            }

            function updateNotesDisplay() {
                notesDisplay.textContent = notesOrder.slice(0, score).map(note => '🎵').join('');
            }

            function resetGame() {
                score = 0;
                scoreDisplay.textContent = score;
                notesDisplay.textContent = '';
                guitar.classList.remove('active');
                target.classList.remove('active');
                endMessage.style.display = 'none';
                startButton.style.display = 'block';
                isGameActive = false;
                currentNoteIndex = 0;
                if (guitarFallTimeout) {
                    clearTimeout(guitarFallTimeout);
                }
            }

            function startGame() {
                if (isGameActive) return;
                isGameActive = true;
                startButton.style.display = 'none';
                endMessage.style.display = 'none';
                guitar.style.display = 'block';
                target.style.display = 'block';
                newGuitar();
            }

            function newGuitar() {
                if (!isGameActive) return;

                guitar.classList.remove('left', 'right');
                guitar.classList.add('active');

                // Alterna la posición de la guitarra
                if (Math.random() > 0.5) {
                    guitarPosition = 'left';
                    guitar.classList.add('left');
                } else {
                    guitarPosition = 'right';
                    guitar.classList.add('right');
                }

                // Asegura que la guitarra se mueva
                setTimeout(() => {
                    guitar.classList.add('fall');
                    guitarFallTimeout = setTimeout(() => {
                        handleMiss();
                    }, 1000);
                }, 500);
            }

            function handleHit() {
                if (!isGameActive) return;

                score++;
                scoreDisplay.textContent = score;
                clearTimeout(guitarFallTimeout);
                
                const noteToPlay = notesOrder[currentNoteIndex % notesOrder.length];
                playNote(noteToPlay);
                currentNoteIndex++;

                updateNotesDisplay();

                guitar.classList.remove('fall');
                guitar.classList.add('hit');
                setTimeout(() => {
                    guitar.classList.remove('hit');
                    if (score < 50) {
                        newGuitar();
                    } else {
                        endGame();
                    }
                }, 500);
            }

            function handleMiss() {
                if (!isGameActive) return;

                guitar.classList.remove('fall');
                guitar.classList.add('miss');
                setTimeout(() => {
                    guitar.classList.remove('miss');
                    endGame();
                }, 500);
            }

            function endGame() {
                isGameActive = false;
                guitar.style.display = 'none';
                target.style.display = 'none';
                endMessage.style.display = 'block';
                finalScore.textContent = `Tu nota final es: ${score}`;
            }

            function handleMotion(event) {
                if (!isGameActive) return;

                const acceleration = event.accelerationIncludingGravity;
                const threshold = 15;

                let isHit = false;

                if (guitarPosition === 'left' && acceleration.x > threshold) {
                    isHit = true;
                } else if (guitarPosition === 'right' && acceleration.x < -threshold) {
                    isHit = true;
                }
                
                if (isHit) {
                    const rectGuitar = guitar.getBoundingClientRect();
                    const rectTarget = target.getBoundingClientRect();
                    
                    const guitarTop = rectGuitar.top;
                    const guitarBottom = rectGuitar.bottom;
                    const targetTop = rectTarget.top;
                    const targetBottom = rectTarget.bottom;

                    if (guitarBottom >= targetTop && guitarTop <= targetBottom) {
                        handleHit();
                    }
                }
            }

            function requestMotionPermission() {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    // iOS 13+
                    DeviceMotionEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('devicemotion', handleMotion);
                                startGame();
                            } else {
                                alert('Permiso denegado. No se puede jugar sin el acelerómetro.');
                            }
                        })
                        .catch(error => {
                            console.error('Error al solicitar permiso:', error);
                            alert('Hubo un error al solicitar el permiso del acelerómetro.');
                        });
                } else {
                    // Otros navegadores
                    window.addEventListener('devicemotion', handleMotion);
                    startGame();
                }
            }

            // Event listener para el botón de inicio
            startButton.addEventListener('click', requestMotionPermission);
            
            // Event listener para el botón de reinicio
            restartButton.addEventListener('click', resetGame);
        });
    </script>
</body>
</html>
